

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wf_psf.psf_models.tf_psf_field &mdash; wf-psf 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9570fddd" />
      <link rel="stylesheet" type="text/css" href="../../../_static/twemoji.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=309026bb" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=af2ce170"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="https://unpkg.com/twemoji@latest/dist/twemoji.min.js"></script>
      <script src="../../../_static/twemoji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffb400" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            wf-psf
              <img src="../../../_static/cosmostat_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About WaveDiff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installing WaveDiff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Running WaveDiff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_execution.html">Basic Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../z_ref.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffb400" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wf-psf</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wf_psf.psf_models.tf_psf_field</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wf_psf.psf_models.tf_psf_field</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Ground-Truth TensorFlow PSF Field Model.</span>

<span class="sd">A module with classes for the Ground-Truth TensorFlow-based PSF field models.</span>

<span class="sd">:Authors: Tobias Liaudat &lt;tobiasliaudat@gmail.com&gt; and Jennifer Pollack &lt;jennifer.pollack@cea.fr&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.python.keras.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_adapter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wf_psf.psf_models.tf_layers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TFZernikeOPD</span><span class="p">,</span>
    <span class="n">TFBatchPolychromaticPSF</span><span class="p">,</span>
    <span class="n">TFBatchMonochromaticPSF</span><span class="p">,</span>
    <span class="n">TFPhysicalLayer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wf_psf.psf_models.psf_model_semiparametric</span><span class="w"> </span><span class="kn">import</span> <span class="n">TFSemiParametricField</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wf_psf.data.training_preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_obs_positions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wf_psf.psf_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">psf_models</span> <span class="k">as</span> <span class="n">psfm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="GroundTruthSemiParamFieldFactory">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.GroundTruthSemiParamFieldFactory">[docs]</a>
<span class="nd">@psfm</span><span class="o">.</span><span class="n">register_psfclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GroundTruthSemiParamFieldFactory</span><span class="p">(</span><span class="n">psfm</span><span class="o">.</span><span class="n">PSFModelBaseFactory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory class for the TensorFlow Ground Truth Physical PSF Field Model.</span>

<span class="sd">    This factory class is responsible for instantiating instances</span>
<span class="sd">    of the TensorFlow Ground Truth SemiParametric PSF Field Model.</span>
<span class="sd">    It is registered with the PSF model factory registry.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ids : tuple</span>
<span class="sd">        A tuple containing identifiers for the factory class.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_model_instance(model_params, training_params, data, coeff_mat=None)</span>
<span class="sd">        Instantiates an instance of the TensorFlow Ground Truth SemiParametric Field class with the provided parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ground_truth_poly&quot;</span><span class="p">,)</span>

<div class="viewcode-block" id="GroundTruthSemiParamFieldFactory.get_model_instance">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.GroundTruthSemiParamFieldFactory.get_model_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">training_params</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">coeff_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Model Instance.</span>

<span class="sd">        This method creates an instance of the TensorFlow Ground Truth SemiParametric PSF Field Model using the provided parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_params: Recursive Namespace</span>
<span class="sd">            A Recursive Namespace object containing parameters for this PSF model class.</span>
<span class="sd">        training_params: Recursive Namespace</span>
<span class="sd">            A Recursive Namespace object containing training hyperparameters for this PSF model class.</span>
<span class="sd">        data: DataConfigHandler</span>
<span class="sd">            A DataConfigHandler object that provides access to training and test datasets, as well as prior knowledge like Zernike coefficients.</span>
<span class="sd">            **Note**: This parameter is not used in this method.</span>
<span class="sd">        coeff_mat: Tensor or None, optional</span>
<span class="sd">            Coefficient matrix defining the parametric PSF field model.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TFGroundTruthSemiParametricField</span>
<span class="sd">            An instance of the TensorFlow Ground Truth SemiParametric PSF Field model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TFGroundTruthSemiParametricField</span><span class="p">(</span>
            <span class="n">model_params</span><span class="p">,</span> <span class="n">training_params</span><span class="p">,</span> <span class="n">coeff_mat</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GroundTruthPhysicalFieldFactory">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.GroundTruthPhysicalFieldFactory">[docs]</a>
<span class="nd">@psfm</span><span class="o">.</span><span class="n">register_psfclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GroundTruthPhysicalFieldFactory</span><span class="p">(</span><span class="n">psfm</span><span class="o">.</span><span class="n">PSFModelBaseFactory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory class for the Tensor Flow Ground Truth Physical PSF Field Model.</span>

<span class="sd">    This factory class is responsible for instantiating instances of the TensorFlow Ground Truth Physical PSF Field Model.</span>
<span class="sd">    It is registered with the PSF model factory registry.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ids : tuple</span>
<span class="sd">        A tuple containing identifiers for the factory class.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_model_instance(model_params, training_params, data, coeff_mat=None)</span>
<span class="sd">        Instantiates an instance of the TensorFlow Physical Polychromatic Field class with the provided parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ground_truth_physical_poly&quot;</span><span class="p">,)</span>

<div class="viewcode-block" id="GroundTruthPhysicalFieldFactory.get_model_instance">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.GroundTruthPhysicalFieldFactory.get_model_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">training_params</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">coeff_mat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Model Instance.</span>

<span class="sd">        This method creates an instance of the TensorFlow Ground Truth SemiParametric PSF Field Model using the provided parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_params: Recursive Namespace</span>
<span class="sd">            A Recursive Namespace object containing parameters for this PSF model class.</span>
<span class="sd">        training_params: Recursive Namespace</span>
<span class="sd">            A Recursive Namespace object containing training hyperparameters for this PSF model class.</span>
<span class="sd">        data: DataConfigHandler</span>
<span class="sd">            A DataConfigHandler object that provides access to training and test datasets, as well as prior knowledge like Zernike coefficients.</span>
<span class="sd">        coeff_mat: Tensor or None, optional</span>
<span class="sd">            Coefficient matrix defining the parametric PSF field model.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TFGroundTruthPhysicalField</span>
<span class="sd">            An instance of the TensorFlow Ground Truth SemiParametric PSF Field model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TFGroundTruthPhysicalField</span><span class="p">(</span>
            <span class="n">model_params</span><span class="p">,</span> <span class="n">training_params</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">coeff_mat</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TFGroundTruthSemiParametricField">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthSemiParametricField">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TFGroundTruthSemiParametricField</span><span class="p">(</span><span class="n">TFSemiParametricField</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A TensorFlow-based Ground Truth Semi-Parametric PSF Field Model.</span>

<span class="sd">    This class represents a ground truth semi-parametric PSF (Point Spread Function)</span>
<span class="sd">    field model implemented using TensorFlow. The model generates a ground truth PSF</span>
<span class="sd">    field based on the provided Zernike coefficient matrix. If the coefficient matrix</span>
<span class="sd">    (`coeff_mat`) is provided, it will be used to produce the ground truth PSF model,</span>
<span class="sd">    which serves as the reference for the previously simulated PSF fields. If no</span>
<span class="sd">    coefficient matrix is provided, the model proceeds without it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_params : RecursiveNamespace</span>
<span class="sd">        A RecursiveNamespace object containing parameters for configuring the PSF model.</span>
<span class="sd">    training_params : RecursiveNamespace</span>
<span class="sd">        A RecursiveNamespace object containing training hyperparameters for the PSF model.</span>
<span class="sd">    coeff_mat : Tensor or None</span>
<span class="sd">        The Zernike coefficient matrix used in generating simulations of the PSF model. This</span>
<span class="sd">        matrix defines the Zernike polynomials up to a given order used to simulate the PSF</span>
<span class="sd">        field. It is only used by this model if present to produce the ground truth PSF model.</span>
<span class="sd">        If not provided, the model will proceed without it.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    GT_tf_semiparam_field : TFSemiParametricField</span>
<span class="sd">        An instance of the TensorFlow-based Semi-Parametric PSF Field Model used for</span>
<span class="sd">        generating ground truth PSF fields.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __init__(model_params, training_params, data, coeff_mat)</span>
<span class="sd">        Initializes the TFGroundTruthSemiParametricField instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TFGroundTruthSemiParametricField.__init__">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthSemiParametricField.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">training_params</span><span class="p">,</span> <span class="n">coeff_mat</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">training_params</span><span class="p">,</span> <span class="n">coeff_mat</span><span class="p">)</span>

        <span class="c1"># For the Ground truth model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_zero_nonparam</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="get_ground_truth_zernike">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.get_ground_truth_zernike">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_ground_truth_zernike</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get Ground Truth Zernikes from the provided dataset.</span>

<span class="sd">    This method concatenates the Ground Truth Zernike from both the training</span>
<span class="sd">    and test datasets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : DataConfigHandler</span>
<span class="sd">        A DataConfigHandler object that provides access to training and test datasets, as well as prior knowledge like Zernike coefficients.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tf.Tensor</span>
<span class="sd">        Tensor containing the observed positions of the stars.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The Zernike Ground Truth are obtained by concatenating the</span>
<span class="sd">    Ground Truth Zernikes from both the training and test datasets</span>
<span class="sd">    along the 0th axis.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zernike_ground_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;zernike_GT&quot;</span><span class="p">],</span>
            <span class="n">data</span><span class="o">.</span><span class="n">test_data</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;zernike_GT&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">zernike_ground_truth</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>



<div class="viewcode-block" id="TFGroundTruthPhysicalField">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TFGroundTruthPhysicalField</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ground Truth PSF field forward model with a physical layer.</span>

<span class="sd">    Ground truth PSF field used for evaluation purposes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ids : tuple</span>
<span class="sd">        A tuple storing the string attribute of the PSF model class</span>
<span class="sd">    model_params : Recursive Namespace</span>
<span class="sd">        A Recursive Namespace object containing parameters for this PSF model class.</span>
<span class="sd">    training_params : Recursive Namespace</span>
<span class="sd">        A Recursive Namespace object containing training hyperparameters for this PSF model class.</span>
<span class="sd">    data : DataConfigHandler object</span>
<span class="sd">        A DataConfigHandler object containing training and tests datasets, as well as prior knowledge like Zernike coefficients.</span>
<span class="sd">    coeff_mat : Tensor or None</span>
<span class="sd">        Initialization of the coefficient matrix defining the parametric PSF field model.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">training_params</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">coeff_mat</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising TFGroundTruthPhysicalField class...&quot;</span><span class="p">)</span>
        <span class="c1"># Inputs: oversampling used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_Q</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">output_Q</span>

        <span class="c1"># Inputs: TF_physical_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_pos</span> <span class="o">=</span> <span class="n">get_obs_positions</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zks_prior</span> <span class="o">=</span> <span class="n">get_ground_truth_zernike</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_zks_prior</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zks_prior</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_zks_total</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">model_params</span><span class="o">.</span><span class="n">param_hparams</span><span class="o">.</span><span class="n">n_zernikes</span><span class="p">,</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zks_prior</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zernike_maps</span> <span class="o">=</span> <span class="n">psfm</span><span class="o">.</span><span class="n">generate_zernike_maps_3d</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_zks_total</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">pupil_diameter</span>
        <span class="p">)</span>

        <span class="c1"># Check if the Zernike maps are enough</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zks_prior</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zks_total</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of Zernike maps is not enough.&quot;</span><span class="p">)</span>

        <span class="c1"># Inputs: TF_zernike_OPD</span>
        <span class="c1"># They are not stored as they are memory-intensive</span>
        <span class="c1"># zernike_maps =[]</span>

        <span class="c1"># Inputs: TF_batch_poly_PSF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">training_params</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obscurations</span> <span class="o">=</span> <span class="n">psfm</span><span class="o">.</span><span class="n">tf_obscurations</span><span class="p">(</span>
            <span class="n">pupil_diam</span><span class="o">=</span><span class="n">model_params</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">,</span>
            <span class="n">N_filter</span><span class="o">=</span><span class="n">model_params</span><span class="o">.</span><span class="n">LP_filter_length</span><span class="p">,</span>
            <span class="n">rotation_angle</span><span class="o">=</span><span class="n">model_params</span><span class="o">.</span><span class="n">obscuration_rotation_angle</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">output_dim</span>

        <span class="c1"># Initialize the physical layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_physical_layer</span> <span class="o">=</span> <span class="n">TFPhysicalLayer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_pos</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zks_prior</span><span class="p">,</span>
            <span class="n">interpolation_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Initialize the zernike to OPD layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_zernike_OPD</span> <span class="o">=</span> <span class="n">TFZernikeOPD</span><span class="p">(</span><span class="n">zernike_maps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zernike_maps</span><span class="p">)</span>

        <span class="c1"># Initialize the batch OPD to batch polychromatic PSF layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_batch_poly_PSF</span> <span class="o">=</span> <span class="n">TFBatchPolychromaticPSF</span><span class="p">(</span>
            <span class="n">obscurations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obscurations</span><span class="p">,</span>
            <span class="n">output_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_Q</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="TFGroundTruthPhysicalField.set_output_Q">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField.set_output_Q">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_output_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_Q</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the value of the output_Q parameter.</span>

<span class="sd">        This method is useful for generating or predicting Point Spread Functions (PSFs) at a different</span>
<span class="sd">        sampling rate compared to the observation sampling. It allows for adjusting the resolution</span>
<span class="sd">        of the generated PSFs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_Q : float</span>
<span class="sd">            The output sampling rate factor, which determines the resolution of the PSFs to be generated.</span>
<span class="sd">        output_dim : int, optional</span>
<span class="sd">            The output dimension of the generated PSFs. If not provided, the existing dimension will be used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            This method does not return any value.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        After setting the `output_Q` and optionally the `output_dim`, the PSF batch polynomial generator</span>
<span class="sd">        is reinitialized with the new parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_Q</span> <span class="o">=</span> <span class="n">output_Q</span>
        <span class="k">if</span> <span class="n">output_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="n">output_dim</span>

        <span class="c1"># Reinitialize the PSF batch poly generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_batch_poly_PSF</span> <span class="o">=</span> <span class="n">TFBatchPolychromaticPSF</span><span class="p">(</span>
            <span class="n">obscurations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obscurations</span><span class="p">,</span>
            <span class="n">output_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_Q</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TFGroundTruthPhysicalField.predict_step">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField.predict_step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">evaluate_step</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply custom prediction (inference) step for the PSF model.</span>

<span class="sd">        This method applies a specialized interpolation required by the physical layer, distinct from the training process. It processes the input data, computes the Zernike coefficients, propagates them to obtain the Optical Path Difference (OPD), and generates the corresponding polychromatic PSFs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : tuple</span>
<span class="sd">            Input data for prediction. Expected to be a tuple containing positions (tf.Tensor) and Spectral Energy Distributions (SEDs) (tf.Tensor), or a batch of data.</span>
<span class="sd">        evaluate_step : bool, optional</span>
<span class="sd">            If True, `data` is used as-is. Otherwise, it is formatted and unpacked using `data_adapter.expand_1d` and `data_adapter.unpack_x_y_sample_weight`. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        poly_psfs : tf.Tensor</span>
<span class="sd">            A tensor of shape `[batch_size, output_dim, output_dim]` containing the computed polychromatic PSFs.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The method assumes `data_adapter.expand_1d` and `data_adapter.unpack_x_y_sample_weight`</span>
<span class="sd">        are used to properly format and extract `input_positions` and `packed_SEDs`.</span>
<span class="sd">        - Unlike standard Keras `predict_step`, this implementation does not expect `sample_weight`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">evaluate_step</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Format input data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data_adapter</span><span class="o">.</span><span class="n">expand_1d</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">input_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data_adapter</span><span class="o">.</span><span class="n">unpack_x_y_sample_weight</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Unpack inputs</span>
        <span class="n">input_positions</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">packed_SEDs</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Predict Zernike coefficients from the parametric model and physical layer</span>
        <span class="n">zks_coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_zernikes</span><span class="p">(</span><span class="n">input_positions</span><span class="p">)</span>

        <span class="c1"># Propagate to obtain the Optical Path Difference (OPD)</span>
        <span class="n">opd_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_zernike_OPD</span><span class="p">(</span><span class="n">zks_coeffs</span><span class="p">)</span>

        <span class="c1"># Compute the polychromatic PSFs</span>
        <span class="n">poly_psfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_batch_poly_PSF</span><span class="p">([</span><span class="n">opd_maps</span><span class="p">,</span> <span class="n">packed_SEDs</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">poly_psfs</span></div>


<div class="viewcode-block" id="TFGroundTruthPhysicalField.predict_mono_psfs">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField.predict_mono_psfs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_mono_psfs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_positions</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">lambda_obs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">phase_N</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict a batch of monochromatic PSFs at the specified positions.</span>

<span class="sd">        This method calculates the monochromatic Point Spread Functions (PSFs) for</span>
<span class="sd">        a given set of input positions, using the observed wavelength and wavefront</span>
<span class="sd">        dimension. The PSFs are computed using a parametric model and a physical layer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_positions : tf.Tensor [batch_dim, 2]</span>
<span class="sd">            A tensor containing the positions (in 2D space) at which to compute the PSF.</span>
<span class="sd">            Shape should be `[batch_dim, 2]`, where `batch_dim` is the batch size.</span>
<span class="sd">        lambda_obs : float</span>
<span class="sd">            The observed wavelength (in micrometers) for which the monochromatic PSFs are to be computed.</span>
<span class="sd">        phase_N : int</span>
<span class="sd">            The required wavefront dimension. This should be calculated using the following:</span>
<span class="sd">            ```</span>
<span class="sd">            simPSF_np = wf_psf.sims.psf_simulator.PSFSimulator(...)</span>
<span class="sd">            phase_N = simPSF_np.feasible_N(lambda_obs)</span>
<span class="sd">            ```</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mono_psf_batch : tf.Tensor</span>
<span class="sd">            A tensor containing the computed batch of monochromatic PSFs for the input positions.</span>
<span class="sd">            The shape of the tensor depends on the model&#39;s implementation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The method uses the `TFBatchMonochromaticPSF` class to handle the computation of</span>
<span class="sd">        monochromatic PSFs. The `set_lambda_phaseN` method is called to set the observed</span>
<span class="sd">        wavelength and wavefront dimension before the PSFs are computed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialise the monochromatic PSF batch calculator</span>
        <span class="n">tf_batch_mono_psf</span> <span class="o">=</span> <span class="n">TFBatchMonochromaticPSF</span><span class="p">(</span>
            <span class="n">obscurations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obscurations</span><span class="p">,</span>
            <span class="n">output_Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_Q</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set the observed wavelength and wavefront dimension</span>
        <span class="n">tf_batch_mono_psf</span><span class="o">.</span><span class="n">set_lambda_phaseN</span><span class="p">(</span><span class="n">phase_N</span><span class="p">,</span> <span class="n">lambda_obs</span><span class="p">)</span>

        <span class="c1"># Predict Zernike coefficients from the parametric model and physical layer</span>
        <span class="n">zks_coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_zernikes</span><span class="p">(</span><span class="n">input_positions</span><span class="p">)</span>

        <span class="c1"># Propagate to obtain the Optical Path Difference (OPD)</span>
        <span class="n">opd_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_zernike_OPD</span><span class="p">(</span><span class="n">zks_coeffs</span><span class="p">)</span>

        <span class="c1"># Compute the monochromatic PSFs</span>
        <span class="n">mono_psf_batch</span> <span class="o">=</span> <span class="n">tf_batch_mono_psf</span><span class="p">(</span><span class="n">opd_maps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mono_psf_batch</span></div>


<div class="viewcode-block" id="TFGroundTruthPhysicalField.predict_opd">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField.predict_opd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_opd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_positions</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the Optical Path Difference (OPD) at the specified positions.</span>

<span class="sd">        This method uses the `predict_zernikes` method to compute Zernike coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_positions: Tensor [batch_dim, 2]</span>
<span class="sd">            Positions to predict the OPD.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        opd_maps : Tensor [batch, opd_dim, opd_dim]</span>
<span class="sd">            OPD at requested positions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Predict Zernikes from parametric model and physical layer</span>
        <span class="n">zks_coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_zernikes</span><span class="p">(</span><span class="n">input_positions</span><span class="p">)</span>

        <span class="c1"># Propagate to obtain the OPD</span>
        <span class="n">opd_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_zernike_OPD</span><span class="p">(</span><span class="n">zks_coeffs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">opd_maps</span></div>


<div class="viewcode-block" id="TFGroundTruthPhysicalField.compute_zernikes">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField.compute_zernikes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_zernikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_positions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Zernike coefficients at a batch of positions.</span>

<span class="sd">        This only includes the physical layer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_positions: Tensor [batch_dim, 2]</span>
<span class="sd">            Positions to compute the Zernikes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        zks_coeffs : Tensor [batch, n_zks_total, 1, 1]</span>
<span class="sd">            Zernikes at requested positions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate the physical layer</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_physical_layer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">input_positions</span><span class="p">)</span></div>


<div class="viewcode-block" id="TFGroundTruthPhysicalField.predict_zernikes">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField.predict_zernikes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_zernikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_positions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict Zernike coefficients at a batch of positions.</span>

<span class="sd">        This only includes the physical layer.</span>
<span class="sd">        For the moment, it is the same as the `compute_zernikes`.</span>
<span class="sd">        No interpolation done to avoid interpolation error in the metrics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_positions: Tensor [batch_dim, 2]</span>
<span class="sd">            Positions to compute the Zernikes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        zks_coeffs : Tensor [batch, n_zks_total, 1, 1]</span>
<span class="sd">            Zernikes at requested positions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate the physical layer</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_physical_layer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_positions</span><span class="p">)</span></div>


<div class="viewcode-block" id="TFGroundTruthPhysicalField.call">
<a class="viewcode-back" href="../../../_autosummary/wf_psf.psf_models.tf_psf_field.html#wf_psf.psf_models.tf_psf_field.TFGroundTruthPhysicalField.call">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the PSF field forward model.</span>

<span class="sd">        [1] From positions to Zernike coefficients</span>
<span class="sd">        [2] From Zernike coefficients to OPD maps</span>
<span class="sd">        [3] From OPD maps and SED info to polychromatic PSFs</span>

<span class="sd">        OPD: Optical Path Differences</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Unpack inputs</span>
        <span class="n">input_positions</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">packed_SEDs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Compute zernikes from parametric model and physical layer</span>
        <span class="n">zks_coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_zernikes</span><span class="p">(</span><span class="n">input_positions</span><span class="p">)</span>

        <span class="c1"># Propagate to obtain the OPD</span>
        <span class="n">opd_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_zernike_OPD</span><span class="p">(</span><span class="n">zks_coeffs</span><span class="p">)</span>

        <span class="c1"># Compute the polychromatic PSFs</span>
        <span class="n">poly_psfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_batch_poly_PSF</span><span class="p">([</span><span class="n">opd_maps</span><span class="p">,</span> <span class="n">packed_SEDs</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">poly_psfs</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20232026, CosmoStat.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XXXXXXXXXX', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>