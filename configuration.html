<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuration &mdash; wf-psf 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/twemoji.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=af2ce170"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js"></script>
        <script src="_static/twemoji.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="wf_psf package" href="wf_psf.html" />
    <link rel="prev" title="Basic Execution" href="basic_execution.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffb400" >

          
          
          <a href="index.html" class="icon icon-home">
            wf-psf
              <img src="_static/cosmostat_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About WaveDiff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installing WaveDiff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Running WaveDiff</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basic_execution.html">Basic Execution</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-configuration">Data Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-configuration">Training Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#metrics-configuration">Metrics Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#plot-configuration">Plot Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#master-configuration">Master Configuration</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="wf_psf.html">wf_psf package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="z_ref.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffb400" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">wf-psf</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Configuration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/configuration.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="configuration">
<h1>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h1>
<p>The WaveDiff pipeline features four main packages for four pipeline tasks:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Pipeline Task</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">training</span></code></p></td>
<td><p>This pipeline task is used to train a PSF model.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">metrics</span></code></p></td>
<td><p>This pipeline task performs metrics evaluations of the trained PSF models.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">plotting</span></code></p></td>
<td><p>This pipeline task is a utility feature for generating plots for the various metrics.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">simPSF</span></code></p></td>
<td><p>This pipeline task is used to simulate stellar PSFs to used as training and test data for the training procedure.<br> (Currently, it runs as a separate code and is not triggered by the command <code class="docutils literal notranslate"><span class="pre">wavediff</span></code>).</p></td>
</tr>
</tbody>
</table>
<p>Configuring WaveDiff to execute one or more of the pipeline tasks (e.g. <code class="docutils literal notranslate"><span class="pre">training</span></code>, <code class="docutils literal notranslate"><span class="pre">metrics</span></code>, or <code class="docutils literal notranslate"><span class="pre">plotting</span></code>) is done by providing as input a specific configuraton file.</p>
<p>The directory tree below shows the various configuration files with their own unique settings for executing a specific task in WaveDiff:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>config
├── configs.yaml
├── data_config.yaml
├── logging.conf
├── metrics_config.yaml
├── plotting_config.yaml
└── training_config.yaml
</pre></div>
</div>
<p>Most of the input configuration files (ending in .yaml) are constructed using <code class="docutils literal notranslate"><span class="pre">YAML</span></code> (Yet Another Markup Language).   The contents of the yaml file are read in as a nested dictionary with key:value pairs.  The <code class="docutils literal notranslate"><span class="pre">logging.conf</span></code> contains configuration settings for storing a log of the run, and in this case we use the <code class="docutils literal notranslate"><span class="pre">ini</span></code> file syntax, which has a section-based structure.  Each section contains one or more key=value pairs, called properties. As a user, you should not modify the names of the keys or sections.  You can modify the value entries.</p>
<p>Next, we shall describe each configuration file.</p>
<section id="data-configuration">
<span id="data-config"></span><h2>Data Configuration<a class="headerlink" href="#data-configuration" title="Link to this heading"></a></h2>
<p>The file <a class="reference external" href="https://github.com/CosmoStat/wf-psf/blob/dummy_main/config/data_config.yaml">data_config.yaml</a> stores the metadata for generating training and test data sets or retrieving existing ones.  A set of training and test data is provided in the <code class="docutils literal notranslate"><span class="pre">data/coherent_euclid_dataset</span></code> directory. New training and test data sets can be produced with the parameters in the file, which <em>should be</em> provided to the <code class="docutils literal notranslate"><span class="pre">simPSF</span></code> code although not at present (implementation upgrade pending).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Training and test data sets for training and/or metrics evaluation</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">training</span><span class="p">:</span>
    <span class="c1"># Specify directory path to data; Default setting is /path/to/repo/data</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">coherent_euclid_dataset</span><span class="o">/</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">train_Euclid_res_200_TrainStars_id_001</span><span class="o">.</span><span class="n">npy</span>
    <span class="c1"># if training data set file does not exist, generate a simulated one by setting values below</span>
    <span class="o">.</span>
    <span class="o">.</span> <span class="o">&lt;</span><span class="n">params</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">training</span> <span class="n">data</span> <span class="nb">set</span><span class="o">&gt;</span>
    <span class="o">.</span>
  <span class="n">test</span><span class="p">:</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">coherent_euclid_dataset</span><span class="o">/</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">test_Euclid_res_id_001</span><span class="o">.</span><span class="n">npy</span>
    <span class="c1"># If test data set file not provided produce a new one</span>
    <span class="o">.</span>
    <span class="o">.</span> <span class="o">&lt;</span><span class="n">params</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">test</span> <span class="n">data</span> <span class="nb">set</span><span class="o">&gt;</span>
    <span class="o">.</span>
</pre></div>
</div>
</section>
<section id="training-configuration">
<span id="training-config"></span><h2>Training Configuration<a class="headerlink" href="#training-configuration" title="Link to this heading"></a></h2>
<p>The file <a class="reference external" href="https://github.com/CosmoStat/wf-psf/blob/dummy_main/config/training_config.yaml">training_config.yaml</a> is used to configure the settings for the training pipeline task. The first line contains the parent key <code class="docutils literal notranslate"><span class="pre">training</span></code>. All the following keys will treated as values of the <code class="docutils literal notranslate"><span class="pre">training</span></code> key. Above each child key a description is provided. Below is a short-hand example of this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">training</span><span class="p">:</span>
  <span class="c1"># Run ID name</span>
  <span class="n">id_name</span><span class="p">:</span> <span class="o">-</span><span class="n">coherent_euclid_200stars</span>

  <span class="c1"># Name of Data Config file</span>
  <span class="n">data_config</span><span class="p">:</span> <span class="n">data_config</span><span class="o">.</span><span class="n">yaml</span> 
  
  <span class="c1"># Metrics Config file - Enter file to run metrics evaluation else if empty run train only</span>
  <span class="n">metrics_config</span><span class="p">:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">metrics_config</span><span class="o">.</span><span class="n">yaml</span>

  <span class="c1"># PSF model parameters</span>
  <span class="n">model_params</span><span class="p">:</span>
    <span class="c1"># Model type.  Options are: &#39;mccd&#39;, &#39;graph&#39;, &#39;poly, &#39;param&#39;, &#39;poly_physical&#39;.&quot;</span>
     <span class="n">model_name</span><span class="p">:</span>
     <span class="o">.</span>
     <span class="o">.</span>
     <span class="o">.</span>
  <span class="c1"># Training hyperparameters</span>
  <span class="n">training_hparams</span><span class="p">:</span>
     <span class="o">.</span>
     <span class="o">.</span>
     <span class="o">.</span>

</pre></div>
</div>
<p>The key <code class="docutils literal notranslate"><span class="pre">id_name</span></code> is used to apply an identifier to the run. The next parameter <code class="docutils literal notranslate"><span class="pre">data_config</span></code> stores the name of the <a class="reference internal" href="#data-config"><span class="std std-ref">data_configuration</span></a> file, which will be parsed by WaveDiff to retrieve the training and test data sets to be used during <code class="docutils literal notranslate"><span class="pre">training</span></code>. The <code class="docutils literal notranslate"><span class="pre">metrics_config</span></code> key is used to trigger the <code class="docutils literal notranslate"><span class="pre">metrics</span></code> pipeline task after the completion of training.  Provide the filename for the <a class="reference internal" href="#metrics-config"><span class="std std-ref">metrics configuration file</span></a> which contains the metrics configuration parameters. This will prompt WaveDiff to launch the <code class="docutils literal notranslate"><span class="pre">metrics</span></code> evaluation of the trained model. If the field is left empty, WaveDiff will run only the <code class="docutils literal notranslate"><span class="pre">training</span></code> pipeline task.
The key <code class="docutils literal notranslate"><span class="pre">model_params</span></code> defines the model parameters for the type of PSF model to be trained.  The identifier of the type of PSF model to be trained is stored in <code class="docutils literal notranslate"><span class="pre">model_name</span></code>.  While the model options are listed in the key description, for now only the <code class="docutils literal notranslate"><span class="pre">poly</span></code> model is implemented.</p>
<p>Training hyperparameters are defined within the parent key: <code class="docutils literal notranslate"><span class="pre">training_hparams</span></code> such as learning rates, the number of epochs and number of multi-cycles, etc.  These parameters can modified by the user. To save the weights and models of all training cycles, set <a class="reference external" href="https://github.com/CosmoStat/wf-psf/blob/425cee776808eb230674103bdb317991dc0922b6/config/training_config.yaml#L105">save_all_cycles</a> to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</section>
<section id="metrics-configuration">
<span id="metrics-config"></span><h2>Metrics Configuration<a class="headerlink" href="#metrics-configuration" title="Link to this heading"></a></h2>
<p>The <a class="reference external" href="https://github.com/CosmoStat/wf-psf/blob/dummy_main/config/metrics_config.yaml">metrics_config.yaml</a> file stores the configuration parameters for the WaveDiff pipeline to carry out a set of computations for the four metrics listed in the table below on a trained PSF model for the input training and test data sets, as applied in <span id="id1">Liaudat <em>et al.</em> [<a class="reference internal" href="z_ref.html#id6" title="Tobias Liaudat, Jean-Luc Starck, Martin Kilbinger, and Pierre-Antoine Frugier. Rethinking data-driven point spread function modeling with a differentiable optical model. Inverse Problems, 39(3):035008, feb 2023. URL: https://dx.doi.org/10.1088/1361-6420/acb664, doi:10.1088/1361-6420/acb664.">2023</a>]</span>.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Metric type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Polychromatic Pixel Reconstruction</p></td>
<td><p>Pixel-based metric that computes the absolute and relative Root Mean <br> Square Error (RMSE) of the pixel reconstruction residuals between the <br> trained polychromatic PSF model and a test data set at low-pixel and <br> super-pixel resolutions.</p></td>
</tr>
<tr class="row-odd"><td><p>Monochromatic Pixel Reconstruction</p></td>
<td><p>Pixel-based metric that computes the absolute and relative Root Mean <br> Square Error (RMSE) of the pixel reconstruction residuals as a function of <br> wavelength between a monochromatic PSF model and the test data set.</p></td>
</tr>
<tr class="row-even"><td><p>Optical Path Differences Reconstruction (OPD)</p></td>
<td><p>Metric that evaluates the absolute and relative RMSE of the residuals <br> between the predicted OPD (Wavefront Error) maps and the ground <br> truth OPD test data set.</p></td>
</tr>
<tr class="row-odd"><td><p>Weak Lensing Shape Metrics</p></td>
<td><p>Second-order moments-based metrics that compute the shape (ellipticity) <br> and size residuals for a PSF at super-pixel resolution (i.e. well-sampled) <br> using <a class="reference external" href="https://galsim-developers.github.io/GalSim/_build/html/hsm.html">GalSim’s HSM module</a>.</p></td>
</tr>
</tbody>
</table>
<p>The test data set referenced in the table for each metric can be composed of noiseless or noisy stars. In the case of noisy stars (such as real data), we caution that the RMSE is not an adequate metric to use to assess the performance of the PSF model.  Alternative formulations are a work-in-progress.  Similarly, both the Monochromatic Pixel Reconstruction and OPD Reconstruction metrics can only be applied to simulated data for which a ground truth model is known. Finally, to apply the Weak Lensing Shape metrics for undersampled PSF observations typical of space experiments like <em>Euclid</em> requires super-resolving the PSF model.</p>
<p>Below is an example of some of the parameters contained in the metrics configuration file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">metrics</span><span class="p">:</span>
   <span class="c1"># Specify the type of model weights to load by entering &quot;psf_model&quot; to load weights of final psf model or &quot;checkpoint&quot; to load weights from a checkpoint callback.</span>
  <span class="n">model_save_path</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">enter</span> <span class="n">psf_model</span> <span class="ow">or</span> <span class="n">checkpoint</span><span class="o">&gt;</span>

  <span class="c1"># Choose the training cycle for which to evaluate the psf_model. Can be: 1, 2, ...</span>
  <span class="n">saved_training_cycle</span><span class="p">:</span> <span class="mi">2</span>
  
  <span class="c1"># Metrics-only run: Specify model_params for a pre-trained model else leave blank if running training + metrics</span>
  <span class="c1"># Specify path to Parent Directory of Trained Model </span>
  <span class="n">trained_model_path</span><span class="p">:</span> <span class="o">&lt;/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">directory</span><span class="o">/</span><span class="n">of</span><span class="o">/</span><span class="n">trained</span><span class="o">/</span><span class="n">model</span><span class="o">&gt;</span>

  <span class="c1"># Path to Trained Model Config file inside /trained_model_path/ parent directory</span>
  <span class="n">trained_model_config</span><span class="p">:</span> <span class="o">&lt;/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">trained</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">file</span><span class="o">&gt;</span>
  
  <span class="c1">#Evaluate the monchromatic RMSE metric.</span>
  <span class="n">eval_mono_metric_rmse</span><span class="p">:</span> <span class="kc">True</span>
  
  <span class="c1">#Evaluate the OPD RMSE metric.</span>
  <span class="n">eval_opd_metric_rmse</span><span class="p">:</span> <span class="kc">True</span>
  
  <span class="c1">#Evaluate the shape RMSE metrics at super-resolution (sr) for the training dataset.</span>
  <span class="n">eval_train_shape_sr_metric_rmse</span><span class="p">:</span> <span class="kc">True</span>

  <span class="c1"># Name of Plotting Config file - Enter name of yaml file to run plot metrics else if empty run metrics evaluation only</span>
  <span class="n">plotting_config</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">enter</span> <span class="n">name</span> <span class="n">of</span> <span class="n">plotting_config</span> <span class="o">.</span><span class="n">yaml</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">leave</span> <span class="n">empty</span><span class="o">&gt;</span>

  <span class="n">ground_truth_model</span><span class="p">:</span>
    <span class="n">model_params</span><span class="p">:</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
  <span class="n">metrics_hparams</span><span class="p">:</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>

</pre></div>
</div>
<p>The metrics key <code class="docutils literal notranslate"><span class="pre">model_save_path</span></code> enables a choice of running the metrics evaluation for a fully trained PSF model or the weights of a given checkpoint cycle.
The parameter <code class="docutils literal notranslate"><span class="pre">saved_training_cycle</span></code> specifies the cycle at which to run metrics evaluation on a fully-trained PSF model or the checkpoint weights.</p>
<p>As stated in the previous section, the <code class="docutils literal notranslate"><span class="pre">metrics</span></code> evaluation pipeline can be executed subsequently after the completion of the <code class="docutils literal notranslate"><span class="pre">training</span></code> routine to evaluate the trained PSF model.  It can also be launched independently to compute the metrics of a previously trained model.  This is done by setting the value of the parameter <code class="docutils literal notranslate"><span class="pre">trained_model_path</span></code> to the absolute path of the parent directory containing the output files of the model.  This is the directory with the naming convention: <code class="docutils literal notranslate"><span class="pre">wf-outputs-timestamp</span></code> (see this <a class="reference internal" href="basic_execution.html#wf-outputs"><span class="std std-ref">example of the run output directory</span></a>).  The user must then provide as a value to <code class="docutils literal notranslate"><span class="pre">trained_model_config</span></code> the subdirectory path to the training configuration file, ex: <code class="docutils literal notranslate"><span class="pre">config/train_config.yaml</span></code>. Below we show an example of this for the case where a user wants to run metrics evaluation of the full PSF model of a pre-trained PSF model saved in the directory <code class="docutils literal notranslate"><span class="pre">wf-outputs-202310161536</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WaveDiff Pre-trained Model
--------------------------

wf-outputs-202310161536
├── checkpoint
│   ├── checkpoint
│   ├── checkpoint_callback_poly-coherent_euclid_200stars_cycle1.data-00000-of-00001
│   ├── checkpoint_callback_poly-coherent_euclid_200stars_cycle1.index
│   ├── checkpoint_callback_poly-coherent_euclid_200stars_cycle2.data-00000-of-00001
│   └── checkpoint_callback_poly-coherent_euclid_200stars_cycle2.index
├── config
│   ├── configs.yaml
│   ├── data_config.yaml
│   ├── metrics_config.yaml
│   └── training_config.yaml
├── log-files
│   └── wf-psf_202310161536.log
├── metrics
│   └── metrics-poly-coherent_euclid_200stars.npy
├── optim-hist
│   └── optim_hist_poly-coherent_euclid_200stars.npy
├── plots
└── psf_model
    ├── checkpoint
    ├── psf_model_poly-coherent_euclid_200stars_cycle1.data-00000-of-00001
    ├── psf_model_poly-coherent_euclid_200stars_cycle1.index
    ├── psf_model_poly-coherent_euclid_200stars_cycle2.data-00000-of-00001
    └── psf_model_poly-coherent_euclid_200stars_cycle2.index

metrics_config.yaml
-------------------

metrics:
   # Specify the type of model weights to load by entering &quot;psf_model&quot; to load weights of final psf model or &quot;checkpoint&quot; to load weights from a checkpoint callback.
  model_save_path: psf_model
  # Choose the training cycle for which to evaluate the psf_model. Can be: 1, 2, ...
  saved_training_cycle: 2
  # Metrics-only run: Specify model_params for a pre-trained model else leave blank if running training + metrics
  # Specify path to Parent Directory of Trained Model 
  trained_model_path: /path/to/wf-outputs-202310161536
  # Path to Trained Model Config file inside /trained_model_path/ parent directory
  trained_model_config: config/training_config.yaml
</pre></div>
</div>
<p>The results of the metrics evaluation will be saved in the new output directory created at runtime (not in the pretrained model directory created previously).</p>
<p>When the trained_model fields are left empty as stated in the commented line, WaveDiff will run the <code class="docutils literal notranslate"><span class="pre">training</span></code> and <code class="docutils literal notranslate"><span class="pre">metrics</span></code> pipelines in serial.  At the start of the <code class="docutils literal notranslate"><span class="pre">metrics</span></code> evaluation task, it will automatically retrieve the model weights at the specific cycle defined by <code class="docutils literal notranslate"><span class="pre">model_save_path</span></code> and <code class="docutils literal notranslate"><span class="pre">saved_training_cycle</span></code> from the <code class="docutils literal notranslate"><span class="pre">wf-outputs-&lt;timestamp&gt;</span></code> sub-directories generated at runtime just before the training task.</p>
<p>The WaveDiff <code class="docutils literal notranslate"><span class="pre">metrics</span></code> pipeline is programmed to automatically evaluate the Polychromatic Pixel reconstruction metrics for both the test (at low- and super-pixel resolution) and training data sets (at low-pixel resolution).  The Monochromatic Pixel Reconstruction and OPD Reconstruction metrics are both optional and can be selected by setting the Boolean flags for <code class="docutils literal notranslate"><span class="pre">eval_{metric_type}_metric_rmse</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> to compute the metric or <code class="docutils literal notranslate"><span class="pre">False</span></code> to disable.  Finally, the Weak Lensing Shape Metrics are computed by default for the test data set at super-pixel resolution and as an option for the training data set by setting the parameter <code class="docutils literal notranslate"><span class="pre">eval_train_shape_sr_metric_rmse</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> (Note: setting this option to <code class="docutils literal notranslate"><span class="pre">True</span></code> will also trigger WaveDiff to compute the Polychromatric Pixel Reconstruction metrics at super-pixel resolution for the training data set).  The table below provides a summary of these different settings.</p>
<table class="docutils align-default" id="metrics-settings">
<thead>
<tr class="row-odd"><th class="head"><p>Metric type</p></th>
<th class="head"><p>Test Data Set</p></th>
<th class="head"><p>Training Data Set</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Polychromatic Pixel Reconstruction</p></td>
<td><p>Default</p></td>
<td><p>Default (low-res), Optional (super-res)</p></td>
</tr>
<tr class="row-odd"><td><p>Monochromatic Pixel Reconstruction</p></td>
<td><p>Optional</p></td>
<td><p>Optional</p></td>
</tr>
<tr class="row-even"><td><p>Optical Path Differences Reconstruction (OPD)</p></td>
<td><p>Optional</p></td>
<td><p>Optional</p></td>
</tr>
<tr class="row-odd"><td><p>Weak Lensing Shape Metrics (super-res only)</p></td>
<td><p>Default</p></td>
<td><p>Optional</p></td>
</tr>
</tbody>
</table>
<p>The option to generate plots of the metric evaluation results is provided by setting the value of the parameter <code class="docutils literal notranslate"><span class="pre">plotting_config</span></code> to the name of the <a class="reference internal" href="#plotting-config"><span class="std std-ref">plotting configuration</span></a> file, ex: <code class="docutils literal notranslate"><span class="pre">plotting_config.yaml</span></code>.  This will trigger WaveDiff’s plotting pipeline to produce plots after completion of the metrics evaluation pipeline.  If the field is left empty, no plots are generated.</p>
<p>To compute the errors of the trained PSF model, the <code class="docutils literal notranslate"><span class="pre">metrics</span></code> package can retrieve a ground truth data set if it exists in dataset files listed in the <a class="reference internal" href="#data-config"><span class="std std-ref">data_configuration</span></a> file. If doesn’t exist, WaveDiff can generate at runtime a <code class="docutils literal notranslate"><span class="pre">ground</span> <span class="pre">truth</span> <span class="pre">model</span></code> using the parameters in the metrics configuration file associated to the key: <code class="docutils literal notranslate"><span class="pre">ground_truth_model</span></code>.  The parameter settings for the ground truth model are similar as those used during <a class="reference internal" href="#training-config"><span class="std std-ref">training configuration</span></a>.  Currently, for the choice of model indicated by the key <code class="docutils literal notranslate"><span class="pre">model_name</span></code>, only the polychromatic model as denoted by <code class="docutils literal notranslate"><span class="pre">poly</span></code> is implemented.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">metrics</span></code> package is run using <a class="reference external" href="https://www.tensorflow.org">TensorFlow</a> to reconstruct the PSF model and evaluate the various metrics. The <code class="docutils literal notranslate"><span class="pre">metrics_hparams</span></code> key contains a couple usual machine learning parameters such as the <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> as well as additional parameters like <code class="docutils literal notranslate"><span class="pre">output_dim</span></code> to define the dimension of the output pixel postage stamp, etc.</p>
</section>
<section id="plot-configuration">
<span id="plotting-config"></span><h2>Plot Configuration<a class="headerlink" href="#plot-configuration" title="Link to this heading"></a></h2>
<p>The <a class="reference external" href="https://github.com/CosmoStat/wf-psf/blob/dummy_main/config/plotting_config.yaml">plotting_config.yaml</a> file stores the configuration parameters for the WaveDiff pipeline to generate plots for the metrics for each dataset listed in the <a class="reference internal" href="#metrics-settings"><span class="std std-ref">metrics settings table</span></a>.</p>
<p>An example of the contents of the <code class="docutils literal notranslate"><span class="pre">plotting_config.yaml</span></code> file is shown below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plotting_params</span><span class="p">:</span>
  <span class="c1"># Specify path to parent folder containing wf-psf metrics outputs for all runs, ex: $WORK/wf-outputs/</span>
  <span class="n">metrics_output_path</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">PATH</span><span class="o">&gt;</span>
  <span class="c1"># List all of the parent output directories (i.e. wf-outputs-xxxxxxxxxxx) that contain metrics results to be included in the plot </span>
  <span class="n">metrics_dir</span><span class="p">:</span> 
    <span class="c1">#     - wf-outputs-xxxxxxxxxxx1 </span>
    <span class="c1">#     - wf-outputs-xxxxxxxxxxx2  </span>
  <span class="c1"># List the corresponding names of the metric config file in each of the parent output directories (would like to change such that code goes and finds them in the metrics_dir)</span>
  <span class="n">metrics_config</span><span class="p">:</span> 
    <span class="c1">#     - metrics_config_1.yaml</span>
    <span class="c1">#     - metrics_config_2.yaml</span>
  <span class="c1"># Show plots flag</span>
  <span class="n">plot_show</span><span class="p">:</span> <span class="kc">False</span>
</pre></div>
</div>
<p>As nearly all of the specific plotting parameters are pre-coded by default, the parameters of the <code class="docutils literal notranslate"><span class="pre">plotting_config</span></code> file are to enable the option to plot multiple metrics from other trained PSF model for comparison. The <code class="docutils literal notranslate"><span class="pre">metrics_output_path</span></code> is the path to the parent directory containing the subdirectories of all runs (see example below).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>wf-outputs/
├── wf-outputs-202305271829
│   ├── config
│   │   ├── data_config.yaml
│   │   └── metrics_config_200.yaml
│   ├── metrics
│   │   └── metrics-poly-coherent_euclid_200stars.npy
├── wf-outputs-202305271845
│   ├── config
│   │   ├── data_config.yaml
│   │   └── metrics_config_500.yaml
│   ├── metrics
│   │   └── metrics-poly-coherent_euclid_500stars.npy
├── wf-outputs-202305271918
│   ├── config
│   │   ├── data_config.yaml
│   │   └── metrics_config_1000.yaml
│   ├── metrics
│   │   └── metrics-poly-coherent_euclid_1000stars.npy

</pre></div>
</div>
<p>Below is the following <code class="docutils literal notranslate"><span class="pre">plotting_config.yaml</span></code> file that would generate plots including each of the three metrics outputs in the example above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>plotting_params:
  # Specify path to parent folder containing wf-psf metrics outputs for all runs, ex: $WORK/wf-outputs/
  metrics_output_path: $WORK/wf-outputs/
  # List all of the parent output directories (i.e. wf-outputs-xxxxxxxxxxx) that contain metrics results to be included in the plot 
  metrics_dir: 
      - wf-outputs-202305271829 
      - wf-outputs-202305271845 
      - wf-outputs-202305271918

  # List the corresponding names of the metric config file in each of the parent output directories (would like to change such that code goes and finds them in the metrics_dir)
  metrics_config: 
      - metrics_config_200.yaml
      - metrics_config_500.yaml
      - metrics_config_1000.yaml

  # Show plots flag
  plot_show: False
</pre></div>
</div>
<p>The only plotting parameter <code class="docutils literal notranslate"><span class="pre">plot_show</span></code> is a Boolean used to trigger a display of the plot at runtime (as in an interactive session).  If False, no plot is displayed.</p>
</section>
<section id="master-configuration">
<span id="master-config-file"></span><h2>Master Configuration<a class="headerlink" href="#master-configuration" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">configs.yaml</span></code> file is the master configuration file that is used to define all of the pipeline tasks to be submitted and executed by <code class="docutils literal notranslate"><span class="pre">WaveDiff</span></code> during runtime. In the <code class="docutils literal notranslate"><span class="pre">configs.yaml</span></code>, the user lists the processing tasks (one or more) to be performed by setting the values of the associated configuration variables <code class="docutils literal notranslate"><span class="pre">{pipeline_task}_conf</span></code> and the name of the configuration file <code class="docutils literal notranslate"><span class="pre">{pipeline_task}_config.yaml</span></code> in the master <code class="docutils literal notranslate"><span class="pre">configs.yaml</span></code> file.  See an example below to configure <code class="docutils literal notranslate"><span class="pre">WaveDiff</span></code> to launch a sequence of runs to train models 1…n with their respectived configurations set in the files <code class="docutils literal notranslate"><span class="pre">training_config_{id}.yaml</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
  <span class="n">training_conf_1</span><span class="p">:</span> <span class="n">training_config_1</span><span class="o">.</span><span class="n">yaml</span>
  <span class="n">training_conf_2</span><span class="p">:</span> <span class="n">training_config_2</span><span class="o">.</span><span class="n">yaml</span>
  <span class="o">...</span>
  <span class="n">training_conf_n</span><span class="p">:</span> <span class="n">training_config_n</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>Each training task is run sequentially and independently of the others.  All of the results are stored in the same <code class="docutils literal notranslate"><span class="pre">wf-outputs-&lt;timestamp&gt;</span></code> directory as shown in the example below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>├── wf-outputs-202310131055
│   ├── checkpoint
│   │   ├── checkpoint
│   │   ├── checkpoint_callback_poly-coherent_euclid_200stars_1_cycle1.data-00000-of-00001
│   │   ├── checkpoint_callback_poly-coherent_euclid_200stars_1_cycle1.index
│   ├── ...
│   │   ├── checkpoint_callback_poly-coherent_euclid_200stars_n_cycle1.data-00000-of-00001
│   │   ├── checkpoint_callback_poly-coherent_euclid_200stars_n_cycle1.index
│   ├── config
│   │   ├── configs.yaml
│   │   ├── data_config.yaml
│   │   ├── training_config_1.yaml
│   │   ├── ...
│   │   └── training_config_n.yaml
│   ├── log-files
│   │   └── wf-psf_202310131055.log
│   ├── optim-hist
│   │   ├── optim_hist_poly-coherent_euclid_200stars_1.npy
│   │   ├── ...
│   │   └── optim_hist_poly-coherent_euclid_200stars_n.npy
│   ├── plots
│   └── psf_model
│       ├── checkpoint
│       ├── psf_model_poly-coherent_euclid_200stars_1_cycle1.data-00000-of-00001
│       ├── psf_model_poly-coherent_euclid_200stars_1_cycle1.index
│       ├── ...
│       ├── psf_model_poly-coherent_euclid_200stars_n_cycle1.data-00000-of-00001
│       ├── psf_model_poly-coherent_euclid_200stars_n_cycle1.index
</pre></div>
</div>
<p>Likewise, to perform a metrics evaluation and generate plots for each training run, as shown above, the corresponding names of the <code class="docutils literal notranslate"><span class="pre">metrics_config.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">plotting_config.yaml</span></code> files need to be provided as values to the corresponding <code class="docutils literal notranslate"><span class="pre">{metrics|plotting}_config</span></code> parameters in <code class="docutils literal notranslate"><span class="pre">training_config_{id}.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">metrics_config.yaml</span></code>, respectively. The same <code class="docutils literal notranslate"><span class="pre">metrics_config.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">plotting_config.yaml</span></code> files can be used for each <code class="docutils literal notranslate"><span class="pre">training_config_{id}.yaml</span></code> file.  Below is an example of the <code class="docutils literal notranslate"><span class="pre">config</span></code> tree structure for a <code class="docutils literal notranslate"><span class="pre">training</span></code> + <code class="docutils literal notranslate"><span class="pre">metrics</span></code> + <code class="docutils literal notranslate"><span class="pre">plotting</span></code> run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>config/
├── configs.yaml
├── data_config.yaml
├── metrics_config.yaml
├── plotting_config.yaml
├── training_config_1.yaml
├── ...
└── training_config_n.yaml
</pre></div>
</div>
<p>Note, in this version of WaveDiff the plots are produced only per each metric per trained model.  To produce a single plot displaying the metrics for each trained model, the user must do so in a different run following the steps defined in <a class="reference internal" href="#plotting-config"><span class="std std-ref">Plot Configuration</span></a>. The next upgrade to WaveDiff will feature the option to produce independent metrics plots per trained model and/or a single master plot for each metric comparing the respective metric results for all trained models.</p>
<p>The master configuration file can include a combination of the three pipeline tasks, i.e. training, metrics and plotting, to do independent tasks like train a new PSF model, compute the metrics of a  pre-trained PSF model, or produce plots for a selection of pre-computed metrics. While currently WaveDiff executes these jobs sequentially on a single GPU, the future plan is to distribute these tasks in parallel across multiple GPUs to accelerate the computation.</p>
<p>If you have any questions or feedback, please don’t hesitate to open a <a class="reference external" href="https://github.com/CosmoStat/wf-psf/issues">Github issue</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="basic_execution.html" class="btn btn-neutral float-left" title="Basic Execution" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="wf_psf.html" class="btn btn-neutral float-right" title="wf_psf package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, CosmoStat.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XXXXXXXXXX', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>